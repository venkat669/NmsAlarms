import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.io.File;
import java.nio.file.Paths;

@Service
public class XmlProcessorService {

    public void fetchXmlFromSbiAndProcess(String outputDirPath) {
        String sbiUrl = "http://localhost:8085/api/generate";

        try {
            // Prepare JSON body
            ObjectMapper mapper = new ObjectMapper();
            String jsonBody = mapper.writeValueAsString(new OutputDirRequest(outputDirPath));

            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);

            HttpEntity<String> entity = new HttpEntity<>(jsonBody, headers);

            // Use exchange() for GET with body
            RestTemplate restTemplate = new RestTemplate();
            ResponseEntity<String> response = restTemplate.exchange(
                    sbiUrl,
                    HttpMethod.GET,
                    entity,
                    String.class
            );

            // Extract filePath from response
            JsonNode jsonNode = mapper.readTree(response.getBody());
            String filePath = jsonNode.get("filePath").asText();

            System.out.println("Received file path: " + filePath);

            // Parse the XML
            File xmlFile = Paths.get(filePath).toFile();
            XmlMapper xmlMapper = new XmlMapper();
            NeidXml neidXml = xmlMapper.readValue(xmlFile, NeidXml.class);

            System.out.println("Timestamp: " + neidXml.getTimestamp());
            neidXml.getNeids().forEach(alarm -> {
                System.out.println("Alarm NE ID: " + alarm.getNe_id());
            });

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    // Helper class for JSON body
    static class OutputDirRequest {
        public String outputDir;
        public OutputDirRequest(String outputDir) {
            this.outputDir = outputDir;
        }
    }
}
